<!DOCTYPE html>
<html lang="zh-CN">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>记一次文件系统性能测试 - morsuning&#39;s Blog</title><meta name="Description" content="morsuning&#39;s porsonal blog"><meta property="og:url" content="http://localhost:1313/posts/record-once-file-system-performance-test/post/">
  <meta property="og:site_name" content="morsuning&#39;s Blog">
  <meta property="og:title" content="记一次文件系统性能测试">
  <meta property="og:description" content="记录一次视频监控场景下对文件系统进行性能测试及简单调优的过程及思路，相关内容已脱敏
1 性能分析方法 可通过日志和检测工具来监控基于fuse实现的用户态文件系统性能">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-11-27T00:00:00+00:00">
    <meta property="article:tag" content="JuiceFS">
    <meta property="article:tag" content="性能">
    <meta property="og:image" content="http://localhost:1313/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/logo.png">
  <meta name="twitter:title" content="记一次文件系统性能测试">
  <meta name="twitter:description" content="记录一次视频监控场景下对文件系统进行性能测试及简单调优的过程及思路，相关内容已脱敏
1 性能分析方法 可通过日志和检测工具来监控基于fuse实现的用户态文件系统性能">
<meta name="application-name" content="morsuning&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="morsuning&#39;s Blog">
<meta name="referrer" content="no-referrer" /><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/record-once-file-system-performance-test/post/" /><link rel="prev" href="http://localhost:1313/posts/storage-concept/post/" /><link rel="next" href="http://localhost:1313/posts/kubernetes-csi-introduce/post/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/css/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="t-SejsMxzsjyn2lHmDr1CGq7A99OHg7n6auhjWhaViI" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "记一次文件系统性能测试",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/record-once-file-system-performance-test\/post\/"
        },"genre": "posts","keywords": "JuiceFS, 性能","wordcount":  2241 ,
        "url": "http:\/\/localhost:1313\/posts\/record-once-file-system-performance-test\/post\/","datePublished": "2023-11-27T00:00:00+00:00","dateModified": "2023-11-27T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "morsuning"},"author": {
                "@type": "Person",
                "name": "morsuning"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="morsuning&#39;s Blog">morsuning&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="morsuning&#39;s Blog">morsuning&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">记一次文件系统性能测试</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>morsuning</a></span>&nbsp;<span class="post-category">included in <a href="/categories/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>文件系统</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-11-27">2023-11-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2241 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;5 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-性能分析方法">1 性能分析方法</a></li>
    <li><a href="#2-性能分析思路">2 性能分析思路</a></li>
    <li><a href="#3-性能分析环境配置及操作">3 性能分析环境配置及操作</a>
      <ul>
        <li><a href="#31-测试环境">3.1 测试环境</a></li>
        <li><a href="#32-测试配置">3.2 测试配置</a></li>
        <li><a href="#33-测试操作">3.3 测试操作</a></li>
      </ul>
    </li>
    <li><a href="#4-测试中产生的部分数据">4 测试中产生的部分数据</a></li>
    <li><a href="#5-测试结果分析">5 测试结果分析</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>记录一次视频监控场景下对文件系统进行性能测试及简单调优的过程及思路，相关内容已脱敏</p>
<h2 id="1-性能分析方法">1 性能分析方法</h2>
<p>可通过日志和检测工具来监控基于fuse实现的用户态文件系统性能</p>
<p>以JuiceFS为例，它提供了访问日志和性能日志以及命令行工具监控文件系统性能，使用方式分别如下：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-shell">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat /path/to/your/.accesslog
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ cat /path/to/your/.perfmetric
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ juicefs stats /path/to/your</span></span></code></pre></div></div>
<h2 id="2-性能分析思路">2 性能分析思路</h2>
<p>在视频监控场景下，文件为多路监源连续追加写入文件系统</p>
<p>假设网络无瓶颈，文件系统内所有存储介质写入速率一致，理想情况下最大带宽：</p>
<ul>
<li>单节点：服务端从本地写入JuiceFS速度为该节点的最大写入速度</li>
<li>3节点：期望最大写入速度为单节点最大写入速度 * 3</li>
</ul>
<p>测试得服务端单节点从本地写入JuiceFS速度如下：</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-plaintext">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">fiotest: (g=0):rw=write,bs=(R)16.0MiB-16.0MiB, (W) 16.0MiB-16.0MiB, (T) 16.0MiB-16.0MiB,ioengine=libaio, iodepth=1
</span></span><span class="line"><span class="cl">fio-3.29
</span></span><span class="line"><span class="cl">Starting 1 process
</span></span><span class="line"><span class="cl">fiotest: Laying out I0 file (1 file / 4096MiB)
</span></span><span class="line"><span class="cl">Jobs: 1 (f=1): [W(1)][100.0%][w=256MiB/s][w=16 IOPS][eta 00m:00s]
</span></span><span class="line"><span class="cl">fiotest: (groupid=0, jobs=1): err= 0: pid=528243: Sun Nov 26 02:26:37 2023
</span></span><span class="line"><span class="cl">write: IOPS=16, BW=257MiB/s (269MB/s)(4096MiB/15937msec); 0 zone resets
</span></span><span class="line"><span class="cl">slat (usec): min=8557, max=18135, avg=9782.97, stdev=718.53
</span></span><span class="line"><span class="cl">clat (nsec) : min=2590, max=19341, avg=6322.75, stdev=2224.38
</span></span><span class="line"><span class="cl">lat (usec): min=8560, max=18145, avg=9791.82, stdev=719.24
</span></span><span class="line"><span class="cl">clat percentiles (nsec):
</span></span><span class="line"><span class="cl">1.00th=[ 2928].
</span></span><span class="line"><span class="cl">5.00th=[ 3376], 10.00th=[ 3856], 20.00th=[ 4448],
</span></span><span class="line"><span class="cl">30.00th=[ 5152],
</span></span><span class="line"><span class="cl">40.00th=[ 5728], 50.00th=[ 6176], 60.00th=[ 6624],
</span></span><span class="line"><span class="cl">70.00th=[ 7264], 80.00th=[ 7776],
</span></span><span class="line"><span class="cl">90.00th=[ 8512], 95.00th=[ 8896],
</span></span><span class="line"><span class="cl">99.00th=[15936],
</span></span><span class="line"><span class="cl">99.50th=[18560], 99.90th=[19328], 99.95th=[19328],
</span></span><span class="line"><span class="cl">99.99th=[19328]
</span></span><span class="line"><span class="cl">bw ( KiB/s) : min=229376, max=294912, per=100.00%, avg=263201.03, stdev=15791.93, samples=31
</span></span><span class="line"><span class="cl">iops: min= 14, max= 18, avg=16.06, stdev= 0.96, samples=31
</span></span><span class="line"><span class="cl">lat (usec)
</span></span><span class="line"><span class="cl">: 4=11.33%, 10=85.16%, 20=3.52%
</span></span><span class="line"><span class="cl">fsync/fdatasync/sync_file_range:
</span></span><span class="line"><span class="cl">sync (nsec) : min=220, max=2550, avg=1182.90, stdev=474.05
</span></span><span class="line"><span class="cl">sync percentiles (nsec):
</span></span><span class="line"><span class="cl">1.00th[3301],
</span></span><span class="line"><span class="cl">5.00th[410], 10.00th[524], 20.00th[700],
</span></span><span class="line"><span class="cl">30.00th[900], 40.00th[1064], 50.00th[1176],
</span></span><span class="line"><span class="cl">60.00th[1336], 70. 00th[1432],
</span></span><span class="line"><span class="cl">80.00th[1608], 90.00th[1848], 95.00th[2008],
</span></span><span class="line"><span class="cl">99.00th[2192],
</span></span><span class="line"><span class="cl">99.50th[2352], 99.90th[2544], 99.95th[2544],
</span></span><span class="line"><span class="cl">99.99th[2544]
</span></span><span class="line"><span class="cl">cpu
</span></span><span class="line"><span class="cl">usr=1.26%, sys=0.51%, ctx=4608, majf=0, minf=11
</span></span><span class="line"><span class="cl">IO depths
</span></span><span class="line"><span class="cl">: 1=199.6%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;64=0.0%
</span></span><span class="line"><span class="cl">submit
</span></span><span class="line"><span class="cl">: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;64=0.0%
</span></span><span class="line"><span class="cl">complete
</span></span><span class="line"><span class="cl">: 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;64=0.0%
</span></span><span class="line"><span class="cl">issued rwts: total=0, 256, 0, 255 short=0, 0, 0, 0 dropped=0, 0, 0, 0
</span></span><span class="line"><span class="cl">latency
</span></span><span class="line"><span class="cl">: target=0, window=0, percentile=100.00%, depth=1
</span></span><span class="line"><span class="cl">Run status group 0 (all jobs):
</span></span><span class="line"><span class="cl">WRITE: bw=257MiB/s (269MB/s), 257MiB/s-257MiB/s (269MB/s-269MB/s), io=4096MiB (4295MB), run=15937-15937msec</span></span></code></pre></div></div>
<p><strong>io路径分析</strong></p>
<p>nfs → 通过前端网络 → JuiceFS → 通过后端网络 → 分布式持久层 → 磁盘</p>
<p>nfs向JuiceFS并发发送io请求，JuiceFS将收到的数据暂写入缓存，达到指定大小后写缓存分布式持久层，分布式持久层返回后该次落盘操作才算成功</p>
<p>因此上述过程中存在2个时延，第一个时延为JuiceFS等待io请求，直到io请求达到指定大小；第二个时延为JuiceFS等待分布式持久层返回</p>
<p>理论上这两个时延时间一致且周期一致，性能最优</p>
<h2 id="3-性能分析环境配置及操作">3 性能分析环境配置及操作</h2>
<h3 id="31-测试环境">3.1 测试环境</h3>
<ul>
<li>服务端配置：曙光Rack/R6440H0 * 3; 2U 32Core; RAM 128G</li>
<li>网络：fio和mdtest测试：3服务端，1客户端，均组bond6_front，网络最大带宽20G/s</li>
</ul>
<h3 id="32-测试配置">3.2 测试配置</h3>
<p>首先JuiceFS在块大小 &gt;= 16m时会直接将数据写对象，因此测试块大小16M的文件写入时需要调大写对象块大小上限，同时打开文件元数据缓存和目录项缓存超时时间来提高连续写入效率</p>
<p>需修改的配置</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-yaml">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">juicefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cacheDir</span><span class="p">:</span><span class="w"> </span><span class="l">/var/powercache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uploadDelay</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">trashDays</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">logDir</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/var/log/juicefs&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">xxxClientPackagePath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/opt/xxx/xxx_client.tar&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">xxxClientPort</span><span class="p">:</span><span class="w"> </span><span class="m">33999</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">backupMeta</span><span class="p">:</span><span class="w"> </span><span class="l">24h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">attr-cache</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 修改项</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entry-cache</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 修改项</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dir-entry-cache</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 修改项</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespaceRootDir</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/xxx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">disable-lock</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cache-type</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">free-ratio-raw</span><span class="p">:</span><span class="w"> </span><span class="m">0.15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">free-ratio-staging</span><span class="p">:</span><span class="w"> </span><span class="m">0.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">extendedParams </span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;--upload-block-size 32 max-uploads 32 --flush-by-no-write 100&#34;</span><span class="w"> </span><span class="c"># 修改项</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bucketName</span><span class="p">:</span><span class="w"> </span><span class="l">xxx-03e89688</span></span></span></code></pre></div></div>
<p>测试前准备</p>
<ol>
<li>在服务端view上共享1个NFS文件夹nfstest</li>
<li>在客户端挂载该目录: <code>mount -t nfs -o vers=3 业务网:/xxx/nfstest /mnt/nfstest</code></li>
<li>在客户端执行fio和mdtest进行测试</li>
</ol>
<h3 id="33-测试操作">3.3 测试操作</h3>
<ol>
<li>执行cp复制3.5G文件结果</li>
</ol>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-shell">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@node1<span class="o">]</span><span class="c1"># time cp openEuler-22.03-LTS-SP1-x86_64-dvd.iso /mnt/nfstest/testos</span></span></span></code></pre></div></div>
<ul>
<li>real 0m8.210s</li>
<li>user 0m0.000s</li>
<li>sys 0m2.236s</li>
</ul>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-shell">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@node1<span class="o">]</span><span class="c1"># ls -1lh openEuler-22.03-LTS-SP1-x86_64-dvd.iso</span></span></span></code></pre></div></div>
<p>root root 3.5G Nov 25 09:58 openEuler-22.03-LTS-SP1-x86_64-dvd.iso</p>
<ol start="2">
<li>
<p>执行2个fio测试，参数及结果如下</p>
<p>(1)4K随机写入:</p>
</li>
</ol>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-shell">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">fio -directory<span class="o">=</span>/mnt/nfstest/test1 -ioengine<span class="o">=</span>libaio -iodepth<span class="o">=</span><span class="m">1</span> -direct<span class="o">=</span><span class="m">1</span> -fsync<span class="o">=</span><span class="m">1</span> -bs<span class="o">=</span>4K -flesize<span class="o">=</span>8M --rw<span class="o">=</span>write -numjobs<span class="o">=</span><span class="m">56</span> -name<span class="o">=</span>fiotest -group_reporting -output<span class="o">=</span>4k_randw.data</span></span></code></pre></div></div>
<p>结果：</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-plaintext">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">fiotest: (groupid=0, jobs=56): err= 0: pid=1668325: Sat Nov 25 16:48:17 2023
</span></span><span class="line"><span class="cl">write: I0PS=2444, BW=9778KiB/s (10.0MB/s)(448MiB/46919msec); 0 zone resets
</span></span><span class="line"><span class="cl">slat (nsec): min=1551, max=q7180, avg=3033.72, stdev=2019.74
</span></span><span class="line"><span class="cl">clat (msec): min=6, max=438, avg=21.69, stdev=22.42
</span></span><span class="line"><span class="cl">Lat (msec): min=6, max=438, avg=21.70, stdev=22.42
</span></span><span class="line"><span class="cl">clat percentiles (msec):
</span></span><span class="line"><span class="cl">1 1.00th=[q], 5.00th=[11], 10.00th=[12], 20.00th=[13],
</span></span><span class="line"><span class="cl">30.00th=[15], 40.00th=[16], 50.00th=[18], 60.00th=[20],
</span></span><span class="line"><span class="cl">70.00th=[22], 80.00th=[25], 90.00th=[34], 95.00th=[42],
</span></span><span class="line"><span class="cl">99.00th=[79], 99.50th=[220], 99.90th=[239], 99.95th=[251],
</span></span><span class="line"><span class="cl">99.99th=[430]
</span></span><span class="line"><span class="cl">bw ( KiB/s): 
</span></span><span class="line"><span class="cl">min= 1752, max=19184, per=100.00%, avg=10366.19, stdev=53.86,
</span></span><span class="line"><span class="cl">samples=4947
</span></span><span class="line"><span class="cl">iops
</span></span><span class="line"><span class="cl">: 
</span></span><span class="line"><span class="cl">min= 438, max= 4796, avg=2591.49, stdev=13.46, samples=4947
</span></span><span class="line"><span class="cl">lat (msec)
</span></span><span class="line"><span class="cl">: 10=4.31%，20=60.64%，50=32.90%，100=1.18%，250=0.90%
</span></span><span class="line"><span class="cl">lat (msec)
</span></span><span class="line"><span class="cl">: 500=0.05%
</span></span><span class="line"><span class="cl">fsync/fdatasync/sync_file_range:
</span></span><span class="line"><span class="cl">sync (nsec): min=16, max=4702, avg=40.81, stdev=30.54
</span></span><span class="line"><span class="cl">sync percentiles (nsec):
</span></span><span class="line"><span class="cl">1.00th=[22]， 5.00th=[23], 10.00th=[26], 20.00th=[32],
</span></span><span class="line"><span class="cl">30.00th=[33], 40.00th=[34], 50.00th=[34], 60.00th=[39]
</span></span><span class="line"><span class="cl">70.00th=[43],80.00th=[47], 90.00th=[54], 95.00th=[64],
</span></span><span class="line"><span class="cl">99.00th=[145], 99.50th=[151], 99.90th=[193]，99.95th=[338],
</span></span><span class="line"><span class="cl">99.99th=[532]
</span></span><span class="line"><span class="cl">cpu
</span></span><span class="line"><span class="cl">: usr=0.01%, sys=0.03%, ctx=114944, majf=0, minf=56
</span></span><span class="line"><span class="cl">I0 depths 
</span></span><span class="line"><span class="cl">: 1=200.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%
</span></span><span class="line"><span class="cl">submit
</span></span><span class="line"><span class="cl">: 0=0.0%， 4=100.0%， 8=0.0%， 16=0.0%， 32=0.0%， 64=0.0%， &gt;=64=0.0%
</span></span><span class="line"><span class="cl">complete : 0=0.0%， 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%
</span></span><span class="line"><span class="cl">issued rwts: total=0,114688,0,114632 short=0,0,0,0 dropped=0,0,0,0
</span></span><span class="line"><span class="cl">Latency
</span></span><span class="line"><span class="cl"> : target=0, window=0, percentile=100.00%, depth=1
</span></span><span class="line"><span class="cl">Run status group 0 (all jobs):
</span></span><span class="line"><span class="cl">WRITE: bw=9778KiB/s (10.0MB/s), 9778KiB/s-9778KiB/s (10.0MB/s-10.0MB/s), io=448MiB (470MB), run=46919-46919msec</span></span></code></pre></div></div>
<p>(2)16M大文件连续写入：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-shell">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">fio -directory<span class="o">=</span>/mnt/nfstest/test2 -ioengine<span class="o">=</span>libaio -iodepth<span class="o">=</span><span class="m">1</span> -direct<span class="o">=</span><span class="m">1</span> -fsync<span class="o">=</span><span class="m">1</span> -bs<span class="o">=</span>16M -filesize<span class="o">=</span>1G --rw<span class="o">=</span>write -numjobs<span class="o">=</span><span class="m">16</span> -name<span class="o">=</span>fiotest -group_reporting -output<span class="o">=</span>16_w.data</span></span></code></pre></div></div>
<p>结果</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-plaintext">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plaintext" data-lang="plaintext"><span class="line"><span class="cl">fiotest2: (groupid=0, jobs=16): err= 0: pid=166q561: Sat Nov 25 16:49:02 2023
</span></span><span class="line"><span class="cl">write: I0PS=38, BW=608MiB/s (638MB/s)(16.0GiB/26934msec); 0 zone resets
</span></span><span class="line"><span class="cl">slat (usec): min=1144, max=3439, avg=1612.21, stdev=208.03
</span></span><span class="line"><span class="cl">clat (msec): min=142, max=643, avg=414.0q, stdev=41.20
</span></span><span class="line"><span class="cl">lat (msec): min=144, max=644, avg=415.70, stdev=41.15
</span></span><span class="line"><span class="cl">clat percentiles (msec):
</span></span><span class="line"><span class="cl"> 1.00th=[284]， 5.00th=[355], 10.00th=[368], 20.00th=[384], 
</span></span><span class="line"><span class="cl"> 30.00th=[397], 40.00th=[409], 50.00th=[418], 60.00th=[426],
</span></span><span class="line"><span class="cl"> 70.00th=[439], 80.00th=[447], 90.00th=[460], 95.00th=[468],
</span></span><span class="line"><span class="cl"> 99.00th=[489], 99.50th=[502], 99.90th=[542], 99.95th=[642],
</span></span><span class="line"><span class="cl"> 99.99th=[642]
</span></span><span class="line"><span class="cl">bw ( KiB/s): min=523436, max=1048576, per=100.00%, avg=624827.94, stdev=12902.57, samples=845
</span></span><span class="line"><span class="cl">iops:
</span></span><span class="line"><span class="cl">min=25，max=64, avg=38.00, stdev=0.80, samples=845
</span></span><span class="line"><span class="cl">lat (msec)
</span></span><span class="line"><span class="cl">: 250=0.68%，500=98.83%, 750=0.49%
</span></span><span class="line"><span class="cl">fsync/fdatasync/sync_file_range:
</span></span><span class="line"><span class="cl">sync (nsec): min=16, max=604, avg=159.23, stdev=85.32
</span></span><span class="line"><span class="cl">sync percentiles (nsec):
</span></span><span class="line"><span class="cl"> 1.00th=[35]， 5.00th=[56], 10.00th=[70], 20.00th=[129] ,
</span></span><span class="line"><span class="cl"> 30.00th=[139], 40.00th=[147], 50.00th=[151], 60.00th=[157] ,
</span></span><span class="line"><span class="cl"> 70.00th=[161], 80.00th=[169], 90.00th=[191], 95.00th=[342],
</span></span><span class="line"><span class="cl"> 99.00th=[540], 99.50th=[580], 99.90th=[604], 99.95th=[604],
</span></span><span class="line"><span class="cl"> 99.99th=[604]
</span></span><span class="line"><span class="cl">cpu
</span></span><span class="line"><span class="cl">usr=0.17%, sys=0.21%, ctx=1082, majf=0, minf=16
</span></span><span class="line"><span class="cl">I0 depths 
</span></span><span class="line"><span class="cl">: 1=198.4%， 2=0.0%， 4=0.0%， 8=0.0%， 16=0.0%， 32=0.0%， &gt;=64=0.0%
</span></span><span class="line"><span class="cl">submit
</span></span><span class="line"><span class="cl">： 0=0.0%， 4=100.0%， 8=0.0%， 16=0.0%， 32=0.0%， 64=0.0%， &gt;=64=0.0%
</span></span><span class="line"><span class="cl">complete
</span></span><span class="line"><span class="cl">: 0=0.0%， 4=100.0%， 8=0.0%， 16=0.0%， 32=0.0%， 64=0.0%， &gt;=64=0.0%
</span></span><span class="line"><span class="cl">issued rwts: total=0,1024,0,1008 short=0,0,0,0 dropped=0,0,0,0
</span></span><span class="line"><span class="cl">Latency
</span></span><span class="line"><span class="cl"> : target=0, window=0, percentile=100.00%, depth=1
</span></span><span class="line"><span class="cl">Run status group 0 (all jobs):
</span></span><span class="line"><span class="cl">WRITE: bw=608MiB/s (638MB/s), 608MiB/s-608MiB/s (638MB/s-638MB/s)， io=16.0GiB (17.2GB), run=26934-26934msec</span></span></code></pre></div></div>
<ol start="3">
<li>执行3次mtest元数据测试
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-shell">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ mpirun --allow-run-as-root localhost:64 -np <span class="m">64</span> mdtest -I <span class="m">20</span> -z <span class="m">2</span> -b <span class="m">10</span> -w <span class="m">131072</span> -e <span class="m">131072</span> -d /mnt/nfstest/perf1 -t -u
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ mpirun --allow-run-as-root localhost:56 -np <span class="m">56</span> mdtest -I <span class="m">50</span> -z <span class="m">2</span> -b <span class="m">10</span> -w <span class="m">524288</span> -e <span class="m">524288</span> -d /mnt/nfstest/perf2 -t -u
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ mpirun --allow-run-as-root localhost:32 -np <span class="m">32</span> mdtest -I <span class="m">20</span> -z <span class="m">2</span> -b <span class="m">10</span> -w <span class="m">1048576</span> -e <span class="m">1048576</span> -d /mnt/nfstest/perf3 -t -u</span></span></code></pre></div></div>
</li>
</ol>
<p>结果略</p>
<h2 id="4-测试中产生的部分数据">4 测试中产生的部分数据</h2>
<p>iostat - 每块磁盘IO情况</p>
<p>mpstat - 系统CPU资源占用情况</p>
<p>juicefs stat - JuiceFS实时性能指标</p>
<p>juicefs .perfmetric - JuiceFS单位时间内IO情况</p>
<p>juicefs .accesslog - JuiceFS访问日志</p>
<p>具体数据略</p>
<h2 id="5-测试结果分析">5 测试结果分析</h2>
<p>观察到2个问题</p>
<ol>
<li>从perfmetric看出，每次JuiceFS写分布式持久层大小(write_cache)不均，理论应该是统一大小</li>
<li>从accesslog看出，刷新时间不均衡，连续写文件理论上间隔应该统一</li>
</ol>
<p>针对问题1，推测可能是NFS问题，尝试在服务器本地写JuiceFS，观察perfmetric日志，发现写入大小一致，证明推测成立，是NFS客户端单位时间内发出的IO大小不一致导致</p>
<p>针对问题2，推测有其他机制触发刷新，将强制刷新时间更改为100s，再次写入数据查看accesslog，发现还是有不均匀的刷新，支持推测成立</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-11-27</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/record-once-file-system-performance-test/post/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/juicefs/">JuiceFS</a>,&nbsp;<a href="/tags/%E6%80%A7%E8%83%BD/">性能</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/storage-concept/post/" class="prev" rel="prev" title="存储领域的概念"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>存储领域的概念</a>
            <a href="/posts/kubernetes-csi-introduce/post/" class="next" rel="next" title="Kubernetes 存储实现原理及简单示例">Kubernetes 存储实现原理及简单示例<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2018 - 2025</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/twemoji/twemoji.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script src="/lib/katex/katex.min.js"></script><script src="/lib/katex/contrib/auto-render.min.js"></script><script src="/lib/katex/contrib/copy-tex.min.js"></script><script src="/lib/katex/contrib/mhchem.min.js"></script><script>window.config={"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"},"twemoji":true};</script><script src="/js/theme.min.js"></script></body>
</html>
